<?php

/**
 * @file
 * Stanford Paragraph Types Defaults.
 */

/**
 * Implements hook_features_api().
 */
function stanford_paragraph_types_defaults_features_api() {
  return array(
    'paragraph_defaults' => array(
      'default_hook' => 'paragraph_defaults',
      'default_file' => FEATURES_DEFAULTS_INCLUDED,
      'feature_source' => TRUE,
      'file' => drupal_get_path('module', 'stanford_paragraph_types_defaults') . '/stanford_paragraph_types_defaults.features.inc',
    ),
  );
}

/**
 * Implements hook_permission().
 */
function stanford_paragraph_types_defaults_permission() {
  return array(
    'administer stanford paragraph types defaults' => array(
      'title' => t('Administer Stanford Paragraph Types Defaults'),
      'description' => t('Create and modify default paragraph items.'),
    ),
  );
}

/**
 * Implements hook_entity_delete().
 */
function stanford_paragraph_types_defaults_entity_delete($entity, $type) {
  if ($type == 'paragraphs_item') {
    $item_id = $entity->item_id;

    $query = db_select('stanford_paragraphs_defaults', 's')
      ->fields('s', array('uid', 'item_ids'))
      ->condition('item_ids', "%:$item_id;%", 'LIKE')
      ->execute()
      ->fetchAllKeyed();

    foreach ($query as $uid => $item_ids) {

      $default_items = unserialize($item_ids);
      unset($default_items[$item_id]);

      if ($default_items) {
        db_update('stanford_paragraphs_defaults')
          ->fields(array('item_ids' => serialize($default_items)))
          ->condition('uid', $uid)
          ->execute();
      }
      else {
        db_delete('stanford_paragraphs_defaults')
          ->condition('uid', $uid)->execute();
      }
    }
  }
}

/**
 * Implements hook_menu().
 */
function stanford_paragraph_types_defaults_menu() {
  $items = array();
  $items['admin/structure/paragraphs/stanford-defaults'] = array(
    'title' => 'Paragraph Defaults',
    'page callback' => 'stanford_ptd_overview',
    'file' => 'stanford_paragraph_types_defaults.forms.inc',
    'access arguments' => array('administer stanford paragraph types defaults'),
    'type' => MENU_LOCAL_TASK | MENU_NORMAL_ITEM,
  );
  $items['admin/structure/paragraphs/stanford-defaults/overview'] = array(
    'title' => 'Paragraph Defaults',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['admin/structure/paragraphs/stanford-defaults/add/%/%/%'] = array(
    'title' => 'Add Default',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('stanford_ptd_add', 5, 6, 7),
    'file' => 'stanford_paragraph_types_defaults.forms.inc',
    'access arguments' => array('administer stanford paragraph types defaults'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/structure/paragraphs/stanford-defaults/edit/%stanford_paragraphs_defaults'] = array(
    'title' => 'Edit Default',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('stanford_ptd_edit', 5),
    'file' => 'stanford_paragraph_types_defaults.forms.inc',
    'access arguments' => array('administer stanford paragraph types defaults'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/structure/paragraphs/stanford-defaults/delete/%stanford_paragraphs_defaults'] = array(
    'title' => 'Delete Default',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('stanford_ptd_delete', 5),
    'file' => 'stanford_paragraph_types_defaults.forms.inc',
    'access arguments' => array('administer stanford paragraph types defaults'),
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Load a single default configuration by uid.
 *
 * @param string $uid
 *   UID to load.
 *
 * @return array|bool
 *   Keyed array of the requested default or false if none exists.
 */
function stanford_paragraphs_defaults_load($uid) {
  if ($default = stanford_paragraphs_defaults_load_multiple(array($uid))) {
    return $default[$uid];
  }
  return FALSE;
}

/**
 * Loads multiple default configurations by requested UID.
 *
 * @param array $uids
 *   UIDs to load.
 *
 * @return array
 *   An associative array with all available defaults.
 */
function stanford_paragraphs_defaults_load_multiple(array $uids = array()) {
  $query = db_select('stanford_paragraphs_defaults', 's')
    ->fields('s');
  if ($uids) {
    $query->condition('uid', $uids, 'IN');
  }
  $results = $query->execute();

  $defaults = array();
  while ($default_item = $results->fetchAssoc()) {
    $item_ids = unserialize(($default_item['item_ids']));
    asort($item_ids);
    $paragraphs = paragraphs_item_load_multiple(array_keys($item_ids));
    $default_item['paragraphs'] = $paragraphs;

    $defaults[$default_item['uid']] = $default_item;
  }
  return $defaults;
}

/**
 * Implements hook_form_alter().
 */
function stanford_paragraph_types_defaults_form_alter(&$form, &$form_state, $form_id) {
  if (!isset($form['#entity_type']) || !isset($form['#bundle'])) {
    return;
  }
  $defaults = stanford_ptd_load_defaults($form['#entity_type'], $form['#bundle']);

  if (!$defaults) {
    return;
  }

  if (isset($form_state['load_default'])) {
    $entity = isset($form['#node']) ? $form['#node'] : $form['#entity'];

    // There's also no use if the form doesn't have these properties.
    if (isset($entity) && isset($form['#entity_type'])) {

      $entity_type = $form['#entity_type'];
      list($id, , $bundle_name) = entity_extract_ids($entity_type, $entity);

      if (!isset($id)) {
        $paragraphs_fields = field_read_fields(array(
          'type' => 'paragraphs',
          'entity_type' => $entity_type,
          'bundle' => $bundle_name,
        ));

        foreach ($paragraphs_fields as $paragraphs_field) {
          $field_name = $paragraphs_field['field_name'];
          if (isset($form[$field_name]) && $form[$field_name]['#access']) {
            // Add the paragraphs field defaults.
            $field = field_info_field($field_name);
            $instance = field_info_instance($entity_type, $field_name, $bundle_name);
            $paragraphs = stanford_ptd_load_default_paragraphs($form['#entity_type'], $form['#bundle'], $form_state['load_default']);

            // Unset the paragraph field.
            unset($form[$field_name]);
            unset($form_state['field'][$field_name]);

            // Order any existing paragraphs in a form we can use to set the
            // default value.
            $items = array();
            foreach ($paragraphs as $paragraphs_item) {
              $items[]['entity'] = replicate_clone_entity('paragraphs_item', $paragraphs_item);
            }
            $paragraphs_field = field_default_form($entity_type, $entity, $field, $instance, LANGUAGE_NONE, $items, $form, $form_state);
            $form += (array) $paragraphs_field;
          }
        }
      }
    }

    return;
  }

  foreach ($defaults as $field_name => $default_items) {
    $form[$field_name]['default_buttons'] = array(
      '#type' => 'container',
      '#title' => t('Build Default'),
      '#weight' => -99,
    );
    foreach ($default_items as $machine_name => $label) {
      $ajax = array('callback' => 'stanford_ptd_build_default_js');
      $form[$field_name]['default_buttons'][$machine_name] = array(
        '#type' => 'submit',
        '#value' => $label,
        '#submit' => array('stanford_ptd_build_default'),
        '#ajax' => $ajax + $form[$field_name]['und']['add_more']['add_more']['#ajax'],
        '#machine_name' => $machine_name,
        '#field_name' => $field_name,
      );
    }
  }
}

function stanford_ptd_build_default_js(&$form, &$form_state) {
  return $form[$form_state['triggering_element']['#field_name']];
}

function stanford_ptd_build_default(&$form, &$form_state) {
  $form_state['load_default'] = $form_state['triggering_element']['#machine_name'];
  $form_state['rebuild'] = TRUE;
}

function stanford_ptd_save_defaults($entity_type, $bundle, $field_name, $label, $machine_name, $value) {
  if (isset($value[LANGUAGE_NONE]) && !empty($value[LANGUAGE_NONE])) {
    $item_ids = array();

    foreach ($value[LANGUAGE_NONE] as $key => &$item) {
      if (isset($item['entity'])) {
        if ($entity = paragraphs_field_get_entity($item)) {
          if (isset($entity->removed) && $entity->removed) {
            $entity->delete();
          }
          else {
            // Save, but don't set the host entity.
            $entity->save(TRUE);
            $item_ids[$entity->item_id] = $item['_weight'];
          }
        }
      }
    }

    if ($item_ids) {
      // Keep track of the entity_id's in our own table.
      $uid = "$entity_type-$bundle-$field_name-$machine_name";
      db_merge('stanford_paragraphs_defaults')
        ->insertFields(array(
          'label' => $label,
          'machine_name' => $machine_name,
          'entity_type' => $entity_type,
          'field_name' => $field_name,
          'bundle' => $bundle,
          'item_ids' => serialize($item_ids),
        ))
        ->updateFields(array(
          'item_ids' => serialize($item_ids),
        ))
        ->key(array(
          'uid' => $uid,
        ))
        ->execute();
    }
  }
}
